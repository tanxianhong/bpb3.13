name: å®‰å…¨æ··æ·†å·¥ä½œæµ
on:
  schedule:
    - cron: '0 9 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹è¿è¡Œ[3](@ref)
  workflow_dispatch:

jobs:
  secure-obfuscation:
    runs-on: ubuntu-latest
    steps:
      # å¼ºåˆ¶åˆ›å»ºç›®å½•ç»“æ„ï¼ˆé˜²è·¯å¾„é”™è¯¯ï¼‰
      - name: åˆå§‹åŒ–å·¥ä½œåŒº
        run: |
          mkdir -p ./src
          mkdir -p ./dist
          
      # ä¸‹è½½æœ€æ–°æºç ï¼ˆéœ€æ›¿æ¢å®é™…URLï¼‰
      - name: è·å–åŸå§‹æ–‡ä»¶
        run: |
          wget -O ./src/origin.js \
          https://raw.githubusercontent.com/æ­£ç¡®è·¯å¾„/unobfuscated-worker.js
        # ç½‘é¡µ1ï¼šä½¿ç”¨wgetä¸‹è½½çš„æœ€ä½³å®è·µ

      # Node.jsç¯å¢ƒé…ç½®
      - name: é…ç½®Nodeç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ç½‘é¡µ6æ¨èçš„LTSç‰ˆæœ¬
          cache: 'npm'

      # å®‰è£…æœ€æ–°æ··æ·†å·¥å…·
      - name: å®‰è£…ä¾èµ–
        run: npm install javascript-obfuscator@latest  # ç½‘é¡µ7æ¨èçš„å®‰è£…æ–¹å¼

      # æ··æ·†å¤„ç†ï¼ˆå«æœ€æ–°å®‰å…¨å‚æ•°ï¼‰
      - name: æ‰§è¡Œä»£ç æ··æ·†
        run: |
          npx javascript-obfuscator ./src/origin.js \
            --output ./dist/_worker.js \
            --compact true \
            --controlFlowFlatteningThreshold 0.75 \
            --identifierNamesGenerator hexadecimal \
            --stringArray true \
            --stringArrayEncoding rc4  # ç½‘é¡µ6çš„å†›äº‹çº§åŠ å¯†é…ç½®
            --transformObjectKeys true \
            --deadCodeInjection false  # ç½‘é¡µ8å»ºè®®å…³é—­çš„è€—èƒ½é€‰é¡¹

      # æ™ºèƒ½æäº¤ï¼ˆé˜²å¾ªç¯è§¦å‘ï¼‰
      - name: è‡ªåŠ¨æäº¤
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ”’ å®‰å…¨æ›´æ–° [skip ci]'  # ç½‘é¡µ3çš„é˜²å¾ªç¯æœºåˆ¶
          file_pattern: 'dist/_worker.js'
          branch: main
          commit_options: '--no-verify'  # è·³è¿‡æäº¤éªŒè¯
