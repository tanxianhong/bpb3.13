name: è‡ªåŠ¨æ··æ·†å·¥ä½œæµ
on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©å‡Œæ™¨1ç‚¹è§¦å‘
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  code-obfuscation:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šè·å–æœ€æ–°ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # ç½‘é¡µ3ï¼šåŸºç¡€æ£€å‡ºé…ç½®

      # æ­¥éª¤2ï¼šå‡†å¤‡Node.jsç¯å¢ƒ
      - name: å®‰è£…Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ç½‘é¡µ6ï¼šæ¨èä½¿ç”¨é•¿æœŸæ”¯æŒç‰ˆæœ¬

      # æ­¥éª¤3ï¼šå®‰è£…æ··æ·†å·¥å…·
      - name: å®‰è£…javascript-obfuscator
        run: npm install javascript-obfuscator  # ç½‘é¡µ5ï¼šæœ¬åœ°å®‰è£…é¿å…æƒé™é—®é¢˜

      # æ­¥éª¤4ï¼šä¸‹è½½å¾…æ··æ·†æ–‡ä»¶
      - name: è·å–åŸå§‹ä»£ç 
        run: |
          wget -O ./src/origin.js \
          https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js

      # æ­¥éª¤5ï¼šæ‰§è¡Œä»£ç æ··æ·†
      - name: æ··æ·†å¤„ç†
        run: |
          npx javascript-obfuscator ./src/origin.js \
            --output ./dist/_worker.js \
            --compact \
            --identifierNamesGenerator mangled \
            --stringArray true \
            --stringArrayEncoding rc4  # ç½‘é¡µ1ï¼šåŸºäºæœ€ä½³å®è·µçš„å‚æ•°é…ç½®

      # æ­¥éª¤6ï¼šè‡ªåŠ¨æäº¤æ›´æ–°
      - name: æäº¤æ··æ·†ä»£ç 
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ”’ è‡ªåŠ¨æ›´æ–°æ··æ·†ä»£ç  [skip ci]'  # ç½‘é¡µ3ï¼šæ·»åŠ è·³è¿‡CIæ ‡è®°
          branch: main
