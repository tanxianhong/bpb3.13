name: 自动混淆工作流
on:
  schedule:
    - cron: '0 1 * * *'  # 每天凌晨1点触发
  workflow_dispatch:     # 支持手动触发

jobs:
  code-obfuscation:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：获取最新代码
      - name: 检出仓库代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # 网页3：基础检出配置

      # 步骤2：准备Node.js环境
      - name: 安装Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 网页6：推荐使用长期支持版本

      # 步骤3：安装混淆工具
      - name: 安装javascript-obfuscator
        run: npm install javascript-obfuscator  # 网页5：本地安装避免权限问题

      # 步骤4：下载待混淆文件
      - name: 获取原始代码
        run: |
          wget -O ./src/origin.js \
          https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js

      # 步骤5：执行代码混淆
      - name: 混淆处理
        run: |
          npx javascript-obfuscator ./src/origin.js \
            --output ./dist/_worker.js \
            --compact \
            --identifierNamesGenerator mangled \
            --stringArray true \
            --stringArrayEncoding rc4  # 网页1：基于最佳实践的参数配置

      # 步骤6：自动提交更新
      - name: 提交混淆代码
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '🔒 自动更新混淆代码 [skip ci]'  # 网页3：添加跳过CI标记
          branch: main
