name: è‡ªåŠ¨ä»£ç æ··æ·†å·¥ä½œæµ
on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©UTCæ—¶é—´å‡Œæ™¨1ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼‰
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  code-protection:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šå‡†å¤‡ç›®å½•ç»“æ„
      - name: åˆ›å»ºå·¥ä½œç›®å½•
        run: |
          mkdir -p ./src   # å¼ºåˆ¶åˆ›å»ºæºæ–‡ä»¶ç›®å½•[6](@ref)
          mkdir -p ./dist  # åˆ›å»ºæ··æ·†æ–‡ä»¶è¾“å‡ºç›®å½•

      # æ­¥éª¤2ï¼šè·å–æœ€æ–°ä»£ç 
      - name: ä¸‹è½½åŸå§‹æ–‡ä»¶
        run: |
          wget -O ./src/origin.js \
          https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js
        # ç½‘é¡µ1ï¼šä½¿ç”¨wgetä¸‹è½½è¿œç¨‹æ–‡ä»¶

      # æ­¥éª¤3ï¼šé…ç½®Node.jsç¯å¢ƒ
      - name: è®¾ç½®Nodeç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # ç½‘é¡µ6ï¼šä½¿ç”¨LTSç‰ˆæœ¬ç¡®ä¿ç¨³å®šæ€§

      # æ­¥éª¤4ï¼šå®‰è£…æ··æ·†å·¥å…·
      - name: å®‰è£…ä¾èµ–åŒ…
        run: npm install javascript-obfuscator  # ç½‘é¡µ3ï¼šæœ¬åœ°å®‰è£…é¿å…æƒé™é—®é¢˜

      # æ­¥éª¤5ï¼šæ‰§è¡Œæ··æ·†å¤„ç†
      - name: æ··æ·†ä»£ç 
        run: |
          npx javascript-obfuscator ./src/origin.js \
            --output ./dist/_worker.js \
            --compact \
            --identifierNamesGenerator mangled \
            --stringArray true \
            --stringArrayEncoding rc4 \
            --transformObjectKeys true
        # ç½‘é¡µ1ï¼šé‡‡ç”¨å†›äº‹çº§RC4åŠ å¯†å’Œå˜é‡åæ··æ·†[4](@ref)

      # æ­¥éª¤6ï¼šè‡ªåŠ¨æäº¤æ›´æ–°
      - name: æäº¤å˜æ›´
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'ğŸ”’ è‡ªåŠ¨æ›´æ–°æ··æ·†ä»£ç  [skip ci]'  # ç½‘é¡µ7ï¼šé˜²æ­¢è§¦å‘æ–°å·¥ä½œæµ
          branch: main
          file_pattern: 'dist/_worker.js'  # ä»…ç›‘æ§æ··æ·†æ–‡ä»¶å˜æ›´
